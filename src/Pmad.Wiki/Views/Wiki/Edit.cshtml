@model Pmad.Wiki.Models.WikiPageEditViewModel
@{
    ViewData["Title"] = Model.IsNew ? $"Create: {Model.PageName}" : $"Edit: {Model.PageName}";
}

<div class="wiki-edit">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>@(Model.IsNew ? "Create" : "Edit"): @Model.PageName</h1>
        <div class="btn-toolbar" role="toolbar">
            <div class="btn-group" role="group">
                <a asp-action="SiteMap" class="btn btn-outline-secondary">
                    <i class="bi bi-map"></i> Site Map
                </a>
                <a asp-action="View" asp-route-id="@Model.PageName" asp-route-culture="@Model.Culture" class="btn btn-secondary">
                    <i class="bi bi-x"></i> Cancel
                </a>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.Culture))
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Editing culture: <strong>@Model.Culture</strong>
        </div>
    }

    <form asp-action="Edit" method="post">
        <input type="hidden" asp-for="PageName" />
        <input type="hidden" asp-for="Culture" />
        <input type="hidden" asp-for="IsNew" />
        <input type="hidden" asp-for="OriginalContentHash" />
        <input type="hidden" asp-for="TemporaryMediaIds" id="temporary-media-ids" />

        <div asp-validation-summary="ModelOnly" class="alert alert-warning" role="alert"></div>

        <div class="mb-3">
            <label asp-for="Content" class="form-label">Content (Markdown)</label>

            <div class="btn-toolbar mb-2" role="toolbar" aria-label="Markdown formatting toolbar">
                <div class="btn-group btn-group-sm me-2" role="group" aria-label="Text formatting">
                    <button type="button" class="btn btn-outline-secondary" data-markdown-action="bold" title="Bold">
                        <i class="bi bi-type-bold"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-markdown-action="italic" title="Italic">
                        <i class="bi bi-type-italic"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-markdown-action="strikethrough" title="Strikethrough">
                        <i class="bi bi-type-strikethrough"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-markdown-action="code" title="Inline Code">
                        <i class="bi bi-code"></i>
                    </button>
                </div>
                <div class="btn-group btn-group-sm me-2" role="group" aria-label="Headings">
                    <button type="button" class="btn btn-outline-secondary" data-markdown-action="h1" title="Heading 1">
                        <strong>H1</strong>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-markdown-action="h2" title="Heading 2">
                        <strong>H2</strong>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-markdown-action="h3" title="Heading 3">
                        <strong>H3</strong>
                    </button>
                </div>
                <div class="btn-group btn-group-sm me-2" role="group" aria-label="Lists">
                    <button type="button" class="btn btn-outline-secondary" data-markdown-action="ul" title="Unordered List">
                        <i class="bi bi-list-ul"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-markdown-action="ol" title="Ordered List">
                        <i class="bi bi-list-ol"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-markdown-action="quote" title="Blockquote">
                        <i class="bi bi-quote"></i>
                    </button>
                </div>
                <div class="btn-group btn-group-sm me-2" role="group" aria-label="Links and media">
                    <button type="button" class="btn btn-outline-secondary" data-markdown-action="link" title="Link">
                        <i class="bi bi-link-45deg"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-markdown-action="page-link" title="Link to Page" data-bs-toggle="modal" data-bs-target="#pageLinkModal">
                        <i class="bi bi-file-text"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-markdown-action="image" title="Image">
                        <i class="bi bi-image"></i>
                    </button>
                </div>
                <div class="btn-group btn-group-sm me-2" role="group" aria-label="Advanced">
                    <button type="button" class="btn btn-outline-secondary" data-markdown-action="codeblock" title="Code Block">
                        <i class="bi bi-code-square"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-markdown-action="hr" title="Horizontal Rule">
                        <i class="bi bi-dash-lg"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-markdown-action="table" title="Table">
                        <i class="bi bi-table"></i>
                    </button>
                </div>
                <div class="btn-group btn-group-sm" role="group" aria-label="Advanced">
                    <button type="button" id="togglePreview" class="btn btn-outline-primary">
                        <i class="bi bi-eye"></i> <span id="previewButtonText">Preview</span>
                    </button>
                </div>
            </div>

            <textarea asp-for="Content" class="form-control font-monospace" rows="20" id="content-textarea"></textarea>
            <div id="preview-container" class="form-control d-none" style="min-height: 500px; overflow-y: auto;">
                <div id="preview-content" class="wiki-content"></div>
                <div id="preview-loading" class="text-center py-3 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading preview...</span>
                    </div>
                </div>
            </div>
            <span asp-validation-for="Content" class="text-danger"></span>
            <div class="form-text">
                Use <a href="https://www.markdownguide.org/basic-syntax/" target="_blank">Markdown syntax</a> to format your content.
                You can drag and drop or paste images and media files directly into the text area.
            </div>
        </div>

        <div class="mb-3">
            <label asp-for="CommitMessage" class="form-label">Commit Message</label>
            <input asp-for="CommitMessage" class="form-control" />
            <span asp-validation-for="CommitMessage" class="text-danger"></span>
            <div class="form-text">
                Describe the changes you made to this page.
            </div>
        </div>

        <div class="d-flex justify-content-between">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> Save Changes
            </button>
            <a asp-action="View" asp-route-id="@Model.PageName" asp-route-culture="@Model.Culture" class="btn btn-outline-secondary">
                Cancel
            </a>
        </div>
    </form>
</div>

<!-- Page Link Modal -->
<div class="modal fade" id="pageLinkModal" tabindex="-1" aria-labelledby="pageLinkModalLabel" aria-hidden="true" data-current-page="@Model.PageName">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pageLinkModalLabel">Insert Link to Page</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="pageSearchInput" placeholder="Search pages...">
                </div>
                <div id="pageListContainer">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="list-group" id="pageList" style="max-height: 400px; overflow-y: auto; display: none;"></div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/lib/pmad-wiki/css/style.css" />
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/lib/pmad-wiki/js/edit.js"></script>
}
